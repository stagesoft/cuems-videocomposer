#!/usr/bin/make -f

export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure -- \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DENABLE_NDI=ON

override_dh_auto_build:
	dh_auto_build

override_dh_auto_install:
	dh_auto_install --destdir=debian/cuems-videocomposer
	
	# Install NDI SDK libraries to private directory
	# This complies with NDI SDK license requirement to not install to system paths
	mkdir -p debian/cuems-videocomposer/usr/lib/cuems-videocomposer
	# Try multiple possible locations for NDI SDK
	NDI_LIB=""; \
	if [ -f "/opt/NDI SDK for Linux/lib/x86_64-linux-gnu/libndi.so.6.2.1" ]; then \
		NDI_LIB="/opt/NDI SDK for Linux/lib/x86_64-linux-gnu/libndi.so.6.2.1"; \
	elif [ -n "$$NDI_SDK_DIR" ] && [ -f "$$NDI_SDK_DIR/lib/x86_64-linux-gnu/libndi.so.6.2.1" ]; then \
		NDI_LIB="$$NDI_SDK_DIR/lib/x86_64-linux-gnu/libndi.so.6.2.1"; \
	elif [ -n "$$NDI_SDK_DIR" ] && [ -f "$$NDI_SDK_DIR/lib/libndi.so.6.2.1" ]; then \
		NDI_LIB="$$NDI_SDK_DIR/lib/libndi.so.6.2.1"; \
	fi; \
	if [ -n "$$NDI_LIB" ]; then \
		cp "$$NDI_LIB" debian/cuems-videocomposer/usr/lib/cuems-videocomposer/; \
		cd debian/cuems-videocomposer/usr/lib/cuems-videocomposer && \
		ln -s libndi.so.6.2.1 libndi.so.6 && \
		ln -s libndi.so.6 libndi.so; \
		echo "NDI SDK libraries installed to private directory"; \
	else \
		echo "WARNING: NDI SDK libraries not found. Package will be built without NDI support."; \
		echo "Set NDI_SDK_DIR environment variable or install NDI SDK to /opt/NDI SDK for Linux/"; \
	fi
	
	# Install NDI compliance documentation
	mkdir -p debian/cuems-videocomposer/usr/share/doc/cuems-videocomposer/NDI-COMPLIANCE
	cp debian/ndi-compliance/EULA debian/cuems-videocomposer/usr/share/doc/cuems-videocomposer/NDI-COMPLIANCE/
	cp debian/ndi-compliance/README debian/cuems-videocomposer/usr/share/doc/cuems-videocomposer/NDI-COMPLIANCE/
	
	# Note: Wrapper script is NOT needed for Debian package because:
	# - rpath is set to /usr/lib/cuems-videocomposer/ in CMakeLists.txt
	# - NDI libraries are installed to /usr/lib/cuems-videocomposer/
	# - Application will find libraries automatically via rpath

override_dh_shlibdeps:
	# Skip shlibdeps for NDI libraries (they're in private directory)
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info

override_dh_strip:
	dh_strip --exclude=libndi.so*

